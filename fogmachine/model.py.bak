from elixir import *

#elixir/sqlalchemy specific config
metadata.bind = "sqlite:///fogmachine.sqlite"
metadata.bind.echo = False
metadata.bind.autocommit = True

class Host(Entity):
    """
    Represents a Virtualized Host in the database, contains information
    pertaining to its attributes
    """
    hostname = Field(Unicode(255), required=True)
    connection = Field(Unicode(255), required=True)
    virt_type = Field(Unicode(255), required=True)
    free_mem = Field(Integer)
    num_guests = Field(Integer)
    guests = OneToMany('Guest')
    
class User(Entity):
    """
    Represents a Fogmachine user, pairs a user to the guests they have checked
    out
    """
    username = Field(Unicode(255), required=True)
    password = Field(Unicode(255), required=True)
    email = Field(Unicode(255), required=True)
    is_admin = Field(Boolean, default=False)
    guests = OneToMany('Guest')
    sets = OneToMany('Set')
    
class GuestTemplate(Entity):
    """
    Represents a template for provisioning a guest, allows for inclusion of
    Cobbler metavariables
    """
    cobbler_profile = Field(Unicode(255), required=True)
    cobbler_metavars = Field(Unicode(255))
    
class GroupElement(Entity):
    """
    Represents a single GuestTemplate element in a GroupTemplate
    """
    guest_template = ManyToOne('GuestTemplate')
    group_template = ManyToOne('GroupTemplate')
    
class Group(Entity):
    """
    Represents a collection of instantiated guests which pertain to an
    organization established in a GroupDefinition object
    """
    name = Field(Unicode(255), required=True)
    owner = ManyToOne('User', required=True)
    guests = OneToMany('Guest')
    template = ManyToOne('GroupTemplate')
    
class GroupTemplate(Entity):
    """
    Represents a collection of GuestTemplate objects
    """
    name = Field(Unicode(255), required=True)
    templates = OneToMany('GroupElement')

class Guest(Entity):
    """
    Represents a Virtualized Guest, paired to its corresponding Host object
    and to the User that created it
    """
    virt_name = Field(Unicode(255), required=True)
    cobbler_profile = Field(Unicode(255), required=True)
    expire_date = Field(DateTime, required=True)
    is_provisioned = Field(Boolean, default=False)
    purpose = Field(Unicode(255), default=u"It is a mystery...")
    state = Field(Unicode(255), default=u"unchecked")
    mac_address = Field(Unicode(255))
    ip_address = Field(Unicode(255))
    hostname = Field(Unicode(255))
    vnc_port = Field(Unicode(255))
    host = ManyToOne('Host', required=True)
    owner = ManyToOne('User')
    
setup_all()
create_all()
